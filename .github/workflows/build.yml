name: æ„å»º Android å’Œ iOS

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    name: æ„å»º Android APK
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: å®‰è£…ä¾èµ–
      run: npm install

    - name: ä¸‹è½½ Gradle Wrapper JAR
      run: |
        mkdir -p android/gradle/wrapper
        curl -L -o android/gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v8.3.0/gradle/wrapper/gradle-wrapper.jar

    - name: è®¾ç½® Gradle æƒé™
      run: chmod +x android/gradlew

    - name: æ„å»º Android Release APK
      run: |
        cd android
        ./gradlew assembleRelease --no-daemon

    - name: ä¸Šä¼  APK
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 30

    - name: åˆ›å»º Releaseï¼ˆä»…æ ‡ç­¾æ¨é€ï¼‰
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: android/app/build/outputs/apk/release/app-release.apk
        body: |
          ## æ‚¬æµ®æ—¶é—´ ${{ github.ref_name }}

          ### Android
          - APK æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª

          ### åŠŸèƒ½
          - â±ï¸ ç²¾ç¡®åˆ°æ¯«ç§’çš„æ—¶é—´æ˜¾ç¤º
          - ğŸŒ ç½‘ç»œæ—¶é—´åŒæ­¥
          - ğŸ“± æ‚¬æµ®çª—æ˜¾ç¤º
          - ğŸ¨ å¯æ‹–åŠ¨ä½ç½®
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    name: æ„å»º iOS IPA
    runs-on: macos-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: å®‰è£…ä¾èµ–
      run: npm install

    - name: å®‰è£… CocoaPods
      run: |
        cd ios
        pod install

    - name: è®¾ç½® Xcode ç‰ˆæœ¬
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: æ„å»º iOS
      run: |
        cd ios
        xcodebuild -workspace FloatingTime.xcworkspace \
          -scheme FloatingTime \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath $PWD/build/FloatingTime.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: å¯¼å‡º IPA
      run: |
        cd ios
        xcodebuild -exportArchive \
          -archivePath $PWD/build/FloatingTime.xcarchive \
          -exportPath $PWD/build \
          -exportOptionsPlist exportOptions.plist \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

    - name: ä¸Šä¼  IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-release
        path: ios/build/*.ipa
        retention-days: 30

    - name: åˆ›å»º Releaseï¼ˆä»…æ ‡ç­¾æ¨é€ï¼‰
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ios/build/*.ipa
        body: |
          ## iOS æ„å»ºå®Œæˆ

          æ³¨æ„: æ­¤ IPA æœªç­¾åï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ã€‚
          ç”Ÿäº§ç¯å¢ƒéœ€è¦é…ç½®æœ‰æ•ˆçš„è¯ä¹¦å’Œæè¿°æ–‡ä»¶ã€‚
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint:
    name: ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: å®‰è£…ä¾èµ–
      run: npm install

    - name: è¿è¡Œ ESLint
      run: npm run lint --if-present

    - name: TypeScript ç±»å‹æ£€æŸ¥
      run: npx tsc --noEmit
